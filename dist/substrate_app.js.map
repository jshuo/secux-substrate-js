{"version":3,"file":"substrate_app.js","sourceRoot":"","sources":["../src/substrate_app.ts"],"names":[],"mappings":"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","sourcesContent":["/** ******************************************************************************\n *  (c) 2019 - 2022 ZondaX AG\n *  (c) 2016-2017 Ledger\n *\n *  Licensed under the Apache License, Version 2.0 (the \"License\");\n *  you may not use this file except in compliance with the License.\n *  You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n *  Unless required by applicable law or agreed to in writing, software\n *  distributed under the License is distributed on an \"AS IS\" BASIS,\n *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n *  See the License for the specific language governing permissions and\n *  limitations under the License.\n ******************************************************************************* */\nimport { ITransport } from '@secux/transport';\nimport {\n  CHUNK_SIZE,\n  errorCodeToString,\n  ERROR_CODE,\n  getVersion,\n  INS,\n  PAYLOAD_TYPE,\n  processErrorResponse,\n  ResponseAddress,\n  ResponseAllowlistHash,\n  ResponseAllowlistPubKey,\n  ResponseSign,\n  ResponseVersion,\n  SCHEME,\n} from './common'\n\nexport class SubstrateApp {\n  transport: ITransport\n  cla: number\n  slip0044: number\n\n  constructor(transport: ITransport, cla: number, slip0044: number) {\n    if (!transport) {\n      throw new Error('Transport has not been defined')\n    }\n    this.transport = transport\n    this.cla = cla\n    this.slip0044 = slip0044\n  }\n\n  static serializePath(slip0044: number, account: number, change: number, addressIndex: number) {\n    if (!Number.isInteger(account)) throw new Error('Input must be an integer')\n    if (!Number.isInteger(change)) throw new Error('Input must be an integer')\n    if (!Number.isInteger(addressIndex)) throw new Error('Input must be an integer')\n\n    const buf = Buffer.alloc(20)\n    buf.writeUInt32LE(0x8000002c, 0)\n    buf.writeUInt32LE(slip0044, 4)\n    buf.writeUInt32LE(account, 8)\n    buf.writeUInt32LE(change, 12)\n    buf.writeUInt32LE(addressIndex, 16)\n    return buf\n  }\n\n  static GetChunks(message: Buffer) {\n    const chunks = []\n    const buffer = Buffer.from(message)\n\n    for (let i = 0; i < buffer.length; i += CHUNK_SIZE) {\n      let end = i + CHUNK_SIZE\n      if (i > buffer.length) {\n        end = buffer.length\n      }\n      chunks.push(buffer.slice(i, end))\n    }\n\n    return chunks\n  }\n\n  static signGetChunks(slip0044: number, account: number, change: number, addressIndex: number, message: Buffer) {\n    const chunks = []\n    const bip44Path = SubstrateApp.serializePath(slip0044, account, change, addressIndex)\n    chunks.push(bip44Path)\n    chunks.push(...SubstrateApp.GetChunks(message))\n    return chunks\n  }\n\n  async getVersion(): Promise<ResponseVersion> {\n    try {\n      return await getVersion(this.transport, this.cla)\n    } catch (e) {\n      return processErrorResponse(e)\n    }\n  }\n\n  async appInfo() {  }\n\n  async getAddress(\n    account: number,\n    change: number,\n    addressIndex: number,\n    requireConfirmation = false,\n    scheme = SCHEME.ED25519,\n  ){\n    const bip44Path = SubstrateApp.serializePath(this.slip0044, account, change, addressIndex)\n\n    let p1 = 0\n    if (requireConfirmation) p1 = 1\n\n    let p2 = 0\n    if (!isNaN(scheme)) p2 = scheme\n    const txBuffer: Buffer = Buffer.allocUnsafe(10)\n    const rsp = await this.transport.Send(0x70, 0xa7, 0, 0, Buffer.concat([txBuffer]))\n  }\n\n  async sign(account: number, change: number, addressIndex: number, message: Buffer, scheme = SCHEME.ED25519) {\n    const txBuffer: Buffer = Buffer.allocUnsafe(10)\n    const rsp = await this.transport.Send(0x70, 0xa7, 0, 0, Buffer.concat([txBuffer]))\n  }\n\n}\n"]}